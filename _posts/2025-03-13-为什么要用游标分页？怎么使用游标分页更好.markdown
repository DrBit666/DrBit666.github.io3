---

layout: post
title: "ä¸ºä»€ä¹ˆè¦ç”¨æ¸¸æ ‡åˆ†é¡µï¼Ÿå¦‚ä½•æ›´å¥½ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ"
date: 2025-03-13 23:31
author: DrBit
tags: MySql
toc: true

---

### 1.ä¼ ç»Ÿåˆ†é¡µçš„å›°å¢ƒ

#### 1.1.limitåˆ†é¡µ
è°ˆåˆ°mysqlçš„åˆ†é¡µï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°limitè¯­æ³•:

```sql
# è·³è¿‡å‰5æ¡ï¼Œå–å10æ¡
SELECT * FROM table_name LIMIT 10 OFFSET 5; 
```

æˆ–è€…ç®€å†™å½¢å¼:

```sql
SELECT * FROM table_name LIMIT 5,10;
```

ç„¶è€Œï¼Œå½“offsetç‰¹åˆ«å¤§æ—¶ï¼Œä½¿ç”¨limitåˆ†é¡µï¼Œéœ€è¦æ‰«æå‰offsetæ¡æ•°æ®å¹¶ä¸¢å¼ƒï¼Œå› æ­¤ï¼Œlimitåˆ†é¡µä¼šéšç€æ•°æ®é‡å¢åŠ è¾¾åˆ°æ€§èƒ½ç“¶é¢ˆ

é‚£æ€ä¹ˆåšï¼Œæ‰èƒ½æ¨è¿Ÿè¿™ç§æ€§èƒ½ç“¶é¢ˆçš„åˆ°æ¥å‘¢ï¼Ÿ

#### 1.2.limitåˆ†é¡µçš„ä¼˜åŒ–ç­–ç•¥

* WHEREå­—æ®µåŠ ç´¢å¼•&&å‡å°‘å›è¡¨
  * ç”±äºB+æ ‘å¶å­ç»“ç‚¹åŒå‘é“¾è¡¨çš„å­˜åœ¨ï¼ŒåŠ ç´¢å¼•å¯ä»¥åŠ å¿«æ‰«æé€Ÿåº¦
  * å‡å°‘å›è¡¨å³å‡å°‘æ‰«ææ—¶é—´
* è¦†ç›–ç´¢å¼•+å­æŸ¥è¯¢
  * ä¸¾ä¸ªğŸŒ°ï¼š

```sql
CREATE INDEX idx_updateTime ON records(updateTime, id);
# ç›´æ¥limitåˆ†é¡µ
# æµç¨‹ï¼š1-ä»idx_updateTimeç´¢å¼•ä¸­æŸ¥å‡ºå‰50005æ¡æ•°æ®id
#       2-åˆ©ç”¨æŸ¥å‡ºæ¥çš„idså›è¡¨50005æ¡æ•°æ®
#       3-ä¸¢å¼ƒå‰50000æ¡æ•°æ®
SELECT * FROM table_name ORDER BY `update_time` limit 50000,5;

# å­æŸ¥è¯¢
# æµç¨‹ï¼š1-å­æŸ¥è¯¢ï¼Œä»idx_updateTimeç´¢å¼•ä¸­æŸ¥å‡ºå‰50005æ¡æ•°æ®id
#       2-ä¸¢å¼ƒå­æŸ¥è¯¢ä¸­æŸ¥å‡ºæ¥çš„å‰50000æ¡id
#       3-ç”¨å‰©ä¸‹5æ¡æ•°æ®idså›è¡¨æŸ¥è¯¢
SELECT * FROM table_name WHERE id IN ( SELECT id FROM table_name ORDER BY `update_time` LIMIT 50000,5);
```
  *å¯ä»¥çœ‹å‡ºï¼Œç¬¬äºŒç§æŸ¥è¯¢æ–¹å¼æ¯”ç¬¬ä¸€ç§æŸ¥è¯¢å°‘äº†50000æ¡æ•°æ®çš„å›è¡¨ï¼Œåªæœ‰å¤–å±‚å›è¡¨äº†5æ¡æ•°æ®*
* æå‰è®¡ç®—åç§»é‡
  * åŸç†åŒä¸Šï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯ä¸ºäº†å‡å°‘å›è¡¨æ¬¡æ•°ä¸å›è¡¨æ•°æ®é‡
* ç¼“å­˜æ•°æ®
* å°†å¤§è¡¨æŒ‰æ—¶é—´åˆ†åŒºï¼ŒæŸ¥è¯¢æ—¶åªæ‰«ææŸåˆ†åŒº

```sql
# åˆ†åŒº
CREATE TABLE records (
  id BIGINT PRIMARY KEY,
  name VARCHAR(50),
  createTime DATETIME,
  updateTime DATETIME
) PARTITION BY RANGE (YEAR(createTime)) (
  PARTITION p2022 VALUES LESS THAN (2023),
  PARTITION p2023 VALUES LESS THAN (2024),
  PARTITION pmax VALUES LESS THAN MAXVALUE
);

# æŸ¥è¯¢
SELECT * FROM records PARTITION (p2023)
ORDER BY updateTime ASC
LIMIT 1000, 10;
```
é€šè¿‡ä¸Šè¿°æ–¹æ³•ï¼Œå¯ä»¥å‡å°‘æ‰«æçš„æ•°æ®é‡æˆ–è€…å‡å°‘å›è¡¨æ•°é‡ï¼Œä½†è¿˜æ˜¯ä¼šå­˜åœ¨æœç´¢å‰Næ¡å¹¶ä¸¢å¼ƒçš„æƒ…å†µ

---

### 2.æ¸¸æ ‡åˆ†é¡µ(cursoråˆ†é¡µ)

ä¸ºäº†è§£å†³æŸ¥è¯¢å‰Næ¡å¹¶ä¸¢å¼ƒè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ(cursoråˆ†é¡µ)

#### 2.1.æ¸¸æ ‡åˆ†é¡µæ˜¯ä»€ä¹ˆ
**æ¯æ¬¡æŸ¥è¯¢åˆ†é¡µæ—¶ï¼Œåˆ©ç”¨ä¸Šä¸€æ¬¡åˆ†é¡µåå¾—å‡ºçš„æ–°cursorï¼Œä½¿ç”¨id>ä¸Šä¸€æ¬¡cursoræ¥æåˆ°offset**

ä¸¾ä¸ªğŸŒ°ï¼š

```sql
# ç¬¬ä¸€æ¬¡æŸ¥è¯¢
SELECT * FROM table_name LIMIT 50;

# ä»ç¬¬ä¸€æ¬¡æŸ¥è¯¢å‡ºçš„ç»“æœé›†ä¸­ï¼Œå–å‡ºæœ€å¤§çš„idï¼Œå‡è®¾è¿™ä¸ªid=prev_max_id
prev_max_id

# ç¬¬äºŒæ¬¡æŸ¥è¯¢
SELECT * FROM table_name WHERE id > prev_max_id LIMIT 50;

# å°†prev_max_idæ›´æ–°ä¸ºæœ€æ–°ç»“æœé›†ä¸­çš„æœ€å¤§idï¼Œç»§ç»­åç»­æŸ¥è¯¢
```

#### 2.2.æ¸¸æ ‡åˆ†é¡µçš„ä¼˜ç¼ºç‚¹

* ç›¸è¾ƒäºä¼ ç»Ÿoffsetåˆ†é¡µï¼Œcursoråˆ†é¡µæœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼Ÿ
  * ç›´æ¥ä½¿ç”¨ä¸»é”®ç´¢å¼•çš„rangeæŸ¥è¯¢ï¼Œé€Ÿåº¦å¿«
  * ä¸éœ€è¦æŸ¥è¯¢å¹¶ä¸¢å¼ƒæ— ç”¨çš„æ•°æ®

* cursoræœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿ
  * ä¸èƒ½å•çº¯ä½¿ç”¨idæ¥è®¡ç®—cursor
  * åœºæ™¯ï¼š

```sql
# æŸå¼ è¡¨æœ‰id,name,update_timeå­—æ®µ,ç°åœ¨è¦æ±‚åˆ†åˆ«æ ¹æ®update_timeå‡åºã€é™åºï¼Œå¹¶ä¸”åˆ†é¡µ50æ¡æŸ¥è¯¢
# é—®é¢˜ï¼šæ’åºå­—æ®µupdate_timeä¸ä¸»é”®idæ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œupdate_timeå¯èƒ½ä¼šéšç€æ•°æ®æ›´æ–°å˜åŒ–,ä¸èƒ½ç›´æ¥ç”¨idç”Ÿæˆcursor
# å¦‚ä½•è§£å†³:1-ä½¿ç”¨æ’åºå­—æ®µupdate_time+id,ä¿è¯å–åˆ°çš„idä¸ºæœ€æ–°æ—¶é—´å†…çš„idæé™å€¼(å·¦æé™orå³æé™)
#          2-ç´¢å¼•å­—æ®µ(update_time+id),åŠ å¿«æŸ¥è¯¢é€Ÿåº¦
ALTER TABLE table_name ADD INDEX idx_update_time(update_time,id);

# å‡è®¾ä¸Šæ¬¡æŸ¥è¯¢å‡ºæ¥çš„æœ€æ–°æ—¶é—´å’Œidæé™å€¼(å‡åºä¸ºæœ€å¤§æ—¶é—´+æœ€å¤§idï¼Œé™åºä¸ºæœ€å°æ—¶é—´+æœ€å°id)åˆ†åˆ«ä¸ºprev_time,prev_id
# å‡åº
SELECT * FROM table_name WHERE update_time > prev_time OR (update_time = prev_time AND id > prev_id) ORDER BY update_time ASC,id ASC;
# é™åº
SELECT * FROM table_name WHERE update_time < prev_time OR (update_time = prev_time AND id < prev_id) ORDER BY update_time DESC, id DESC;
```

  * å‘å‰åˆ†é¡µä¸å‹å¥½
    * å‘å‰åˆ†é¡µæ—¶ï¼Œéœ€è¦åè½¬å‘ååˆ†é¡µçš„é€»è¾‘

```sql
# å‡åºï¼Œå‘åç¿»é¡µ
# å‡è®¾è¿™ä¸€é¡µæœ€åä¸€æ¡æ•°æ®çš„update_timeå’Œidåˆ†åˆ«ä¸º,last_time,last_id
SELECT * FROM table_name WHERE update_time > prev_time OR (update_time = prev_time AND id > prev_id) ORDER BY update_time ASC,id ASC;

# å‡åºï¼Œå‘å‰ç¿»é¡µ
# å‡è®¾è¿™ä¸€é¡µç¬¬ä¸€æ¡æ•°æ®çš„update_timeå’Œidåˆ†åˆ«ä¸º,first_time,first_id
SELECT * FROM table_name WHERE update_time < first_time OR (update_time = first_time AND id < first_id) ORDER BY update_time ASC,id ASC;

# é™åºåŒç†
```

  * ä¸æ”¯æŒé¡µé¢è·³è½¬(è·³è½¬åˆ°100é¡µ)
    * å¯¹äºé¡µé¢è·³è½¬ï¼Œæ¸¸æ ‡åˆ†é¡µæ”¯æŒéš¾åº¦å¾ˆå¤§ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨limit+å­æŸ¥è¯¢çš„æ–¹å¼åˆ†é¡µ
    * å¦‚æœå®åœ¨è¦ä½¿ç”¨cursoråˆ†é¡µï¼Œå¯ä»¥å¼‚æ­¥å°†æ¯ä¸€é¡µçš„æ¸¸æ ‡åˆ·åˆ°ç¼“å­˜é‡Œ(æ¯æ¬¡æ•°æ®æ›´æ–°æ—¶å¼‚æ­¥åˆ·ç¼“å­˜)

---

### 3.æ‹“å±•ï¼šåˆ†é¡µä¸­çš„åŠ¨æ€è¾¹ç•Œæ›´æ–°

#### 3.1.ä»€ä¹ˆæ˜¯åŠ¨æ€è¾¹ç•Œæ›´æ–°
* åŠ¨æ€æ›´æ–°
  * è¡¨ä¸­æ•°æ®ä¸æ–­æ’å…¥æˆ–æ›´æ–°
* è¾¹ç•Œæƒ…å†µ
  * åˆ†é¡µè¿‡ç¨‹ä¸­ï¼Œæ•°æ®å˜åŒ–å‘ç”Ÿåœ¨å½“å‰é¡µçš„èµ·ç‚¹æˆ–ç»ˆç‚¹é™„è¿‘ï¼Œå¯¼è‡´ç»“æœå¯èƒ½ä¸é¢„æœŸä¸ç¬¦
* æ ¸å¿ƒé—®é¢˜
  * æ¸¸æ ‡åˆ†é¡µä¾èµ–ä¸Šä¸€é¡µçš„æœ€åä¸€ä¸ªå€¼ï¼Œä½†æ•°æ®å˜åŒ–å¯èƒ½ä½¿æ¸¸æ ‡å¤±æ•ˆæˆ–åç§»
  * limitåˆ†é¡µä¾èµ–æ¯é¡µçš„æ¡æ•°ï¼Œå¦‚æœä¸Šä¸€é¡µçš„æ•°æ®æ’å…¥ï¼Œå¯èƒ½å¯¼è‡´æŸ¥è¯¢åˆ°é‡å¤æ•°æ®
  * åŸºäºå„ç§è¾¹ç•Œç‰¹æ®Šæƒ…å†µï¼Œå¯èƒ½å¯¼è‡´é‡å¤ã€é—æ¼ã€åç§»ç­‰æƒ…å†µ

#### 3.2.å¦‚ä½•å¤„ç†åŠ¨æ€æ›´æ–°è¾¹ç•Œæƒ…å†µ
* é»˜è®¤è¡Œä¸ºï¼šæ¥å—åŠ¨æ€æ€§(æ›´å»ºè®®)
  * åˆ†é¡µåº”å½“åæ˜ æ•°æ®çš„æœ€æ–°çŠ¶æ€ï¼Œä¸è¿½æ±‚ä¿è¯"å†å²ä¸€è‡´æ€§"
  * å®æ—¶æ€§å¼ºï¼Œé€‚åˆåŠ¨æ€ç³»ç»Ÿ
  * ä½†æ˜¯å¯èƒ½æœ‰é‡å¤æˆ–é—æ¼è®°å½•
* ä½¿ç”¨å¿«ç…§æ—¶é—´
  * æ–°å¢ä¸€ä¸ªå¿«ç…§å­—æ®µï¼Œè®°å½•æŸ¥è¯¢æ—¶çš„å¿«ç…§,snapshot_time
  * æ¯æ¬¡æŸ¥è¯¢æ—¶ï¼Œå°†snapshot_timeä½œä¸ºæ¡ä»¶ä¹‹ä¸€ï¼Œå›ºå®šæ—¶é—´ç‚¹æŸ¥è¯¢è¿‡çš„æ•°æ®ä¸å†æŸ¥è¯¢

```sql
ALTER TABLE table_name ADD COLUMN snapshot_time DATETIME DEFAULT CURRENT_TIMESTAMP;

SELECT id, name, updateTime
FROM records
WHERE snapshot_time <= 'ä¸Šä¸€ä¸ªæŸ¥è¯¢æ—¶é—´'
ORDER BY updateTime ASC, id ASC
LIMIT 2;
```

  * è¿™ç§æ–¹å¼å…¶å®ä¸å»ºè®®ï¼Œæ—¢éœ€è¦é¢å¤–ç»´æŠ¤ä¸€ä¸ªå­—æ®µï¼Œæ•°æ®ä¹Ÿä¼šå¤±å»å®æ—¶æ€§

### 4.æ€»ç»“
å¯¹äºæ•°æ®é‡ä¸å¤§çš„åœºæ™¯æ¥è¯´ï¼Œä½¿ç”¨limitåˆ†é¡µè¶³å¤Ÿ,limitåˆ†é¡µç®€å•ï¼Œä¾¿äºç»´æŠ¤ï¼Œä¹Ÿèƒ½æ”¯æŒåŠ¨æ€è·³è½¬é¡µé¢

å¯¹äºæ•°æ®é‡å¾ˆå¤§åœºæ™¯ï¼Œä¸ºäº†è§£å†³æ·±åº¦åˆ†é¡µçš„ç“¶é¢ˆé—®é¢˜ï¼Œéœ€è¦é€‰æ‹©cursoråˆ†é¡µæ–¹å¼ï¼Œcursoråˆ†é¡µé¿å…äº†æ— ç”¨è¡Œçš„æ‰«æï¼Œæé«˜äº†æ¯æ¬¡æŸ¥è¯¢çš„æ•ˆç‡ã€‚
ä½†æ˜¯cursoråˆ†é¡µå¯¹äºå‘å‰è·³è½¬é¡µé¢ä¸å‹å¥½ï¼Œä¹Ÿä¸æ”¯æŒé¡µé¢è·³è½¬ï¼Œå¯¹äºè¿™äº›ç‰¹æ®Šæƒ…å†µéœ€è¦æœ‰ç‰¹æ®Šå¤„ç†

å½“ç¢°åˆ°åŠ¨æ€è¾¹ç•Œæ›´æ–°æƒ…å†µæ˜¯ï¼Œå»ºè®®æ¥å—åŠ¨æ€æ€§ï¼Œè¿™æ ·æœ€ç¬¦åˆåŠ¨æ€ç³»ç»ŸçŠ¶æ€
